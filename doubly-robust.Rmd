---
---
---

## How

First things first, notation. I follow Funk et al., except that I use $D$ instead of $X$ to denote treatment, to avoid confusion given you’ll often see $X$ used elsewhere to denote covariates. Here is a full list of the terms we’re going to use:

$\textbf{Z}$ are characteristics (that is, covariates) of individuals in our data\
$D$ is a binary treatment indicator equal to $1$ if an individual is exposed to treatment or $0$ if they aren’t\
$Y_{D=1}$ and $Y_{D=0}$ are *observed* outcomes for individuals in the treatment and control groups, respectively\
$\hat{Y}_{D=1}$ and $\hat{Y}_{D=0}$ are *predicted* outcomes under treatment and control, respectively\
$m1(\textbf{Z_i}, \hat{\alpha}_1)$ and $m0(\textbf{Z_i}, \hat{\alpha}_0)$ are the models we’ll use to predict $\hat{Y}_{D=1}$ and $\hat{Y}_{D=0}$ for each individual, where $\textbf{Z_i}$ are that individual's characteristics and $\hat{\alpha}_1$ and $\hat{\alpha}_0$ are coefficients that describe the estimated relationships between characteristics and outcomes in the treatment and control groups; we get $\hat{\alpha}_1$ and $\hat{\alpha}_0$ by fitting linear regression models that predict outcomes using characteristics [\^1]: Per usual, any term with a "hat" is an estimate of a true quantity we can't measure directly\
$PS=P[D=1|\textbf{Z}]$ is the propensity score, which measures how likely an individual is to be exposed to treatment based on their characteristics\
$e(\textbf{Z_i}, \hat{\beta})$ is the model we'll use to estimate the propensity score, where $\textbf{Z_i}$ are once again and individual's characteristics and $\hat{\beta}$ is a coefficient that describes the estimated relationship between characteristics and treatment propensity; we get $\hat{\beta}$ by fitting a logistic regression model that predicts treatment using characteristics

```{r}
library(tidyverse)
set.seed(0)
```

```{r}
n = 2000

# GENERATE IVs
z1 <- rnorm(n, mean = 0, sd = 1)
z2 <- rnorm(n, mean = 0, sd = 1)
z3 <- replicate(n, ifelse(rnorm(1, mean = 0, sd = 1) <= 0.3, 1, 0))

# GENERATE EXPOSURE AS A FUNCTION OF IVs

# Set betas for true model
b0_0 = 1.5
b1_0 = 1
b2_0 = -2
b3_0 = 1

# Calculate true propensity scores (logit)
ps <- (1 + exp(b0_0 + b1_0*z1 + b2_0*z2 + b3_0*z3))^(-1)

# Calculate exposure
d <- ifelse(ps + runif(n, min = 0, max = 1) < 0.91, 1, 0)

# GENERATE TRUE OUTCOMES
b4_0 <- 2
z4 <- rnorm(n, mean = 0, sd = 1)
y <- b1_0*z1 + b3_0*z3 + b4_0*z4

# TRUE DATA
data <- tibble(z1, z2, z3, d, ps, y)
```

```{r}
# GENERATE ESTIMATED OUTCOMES

# Scenario 1

# Fit propensity score model
ps_1 <- glm(d ~ z1 + z3, data = data, family = 'binomial') # Logit

# Predict propensity scores
data <- data %>% mutate(ps1 = predict(ps_1, data))

# Fit outcome regression models
modt_1 <- lm(y ~ z1 + z3, data = data %>% filter(d == 1))
modc_1 <- lm(y ~ z1 + z3, data = data %>% filter(d == 0))

# Predict outcomes
data <- data %>% mutate(yhat1_1 = predict(modt_1, data))
data <- data %>% mutate(yhat0_1 = predict(modc_1, data))

# Compute doubly robust estimates
data <- data %>% mutate(dr1_1 = 
                          ifelse(d == 1, 
                                 ((y / ps1) - ((yhat1_1 * (1 - ps1)) / (ps1))),
                                 (yhat1_1)),
                        dr1_0 =
                          ifelse(d == 1,
                                 (yhat0_1),
                                 ((y / (1 - ps1) - ((yhat0_1 * ps1) / (1 - ps1))))))

# Compute ATE
(mean(data$dr1_1) - mean(data$dr1_0))
```
