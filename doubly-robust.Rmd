
```{r}
library(tidyverse)
set.seed(0)
```

```{r}
# Notation

# Parameters (betas)
# b<subscript>_<exposure>_<scenario>
# Ex: b1_c_1 is beta 1 for the scenario 1 outcome regression model 
  # estimated on the control data (c)

# Simple estimates (yhats)
# yhat<estimated condition>_<true condition>_<scenario>
# Ex:

# Doubly robust estimates (drs) 
```

```{r}
n = 2000

# GENERATE IVs
z1 <- rnorm(n, mean = 0, sd = 1)
z2 <- rnorm(n, mean = 0, sd = 1)
z3 <- replicate(n, ifelse(rnorm(1, mean = 0, sd = 1) <= 0.3, 1, 0))

# GENERATE EXPOSURE AS A FUNCTION OF IVs

# Set betas for true model
b0_0 = 1.5
b1_0 = 1
b2_0 = -2
b3_0 = 1

# Calculate true propensity scores (logit)
ps <- (1 + exp(b0_0 + b1_0*z1 + b2_0*z2 + b3_0*z3))^(-1)

# Calculate exposure
d <- ifelse(ps + runif(n, min = 0, max = 1) < 0.91, 1, 0)

# GENERATE TRUE OUTCOMES
b4_0 <- 2
z4 <- rnorm(n, mean = 0, sd = 1)
y <- b1_0*z1 + b3_0*z3 + b4_0*z4

# TRUE DATA
data <- tibble(z1, z2, z3, d, ps, y)
```


```{r}
# GENERATE ESTIMATED OUTCOMES

# Scenario 1

# Fit propensity score model
ps_1 <- glm(d ~ z1 + z3, data = data, family = 'binomial') # Logit

# Predict propensity scores
data <- data %>% mutate(ps1 = predict(ps_1, data))

# Fit outcome regression models
modt_1 <- lm(y ~ z1 + z3, data = data %>% filter(d == 1))
modc_1 <- lm(y ~ z1 + z3, data = data %>% filter(d == 0))

# Predict outcomes
data <- data %>% mutate(yhat1_1 = predict(modt_1, data))
data <- data %>% mutate(yhat0_1 = predict(modc_1, data))
```

